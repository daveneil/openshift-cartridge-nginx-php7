#!/bin/bash
set -e

source ${OPENSHIFT_CARTRIDGE_SDK_BASH}

case "$1" in
  -v|--version)
    version="$2"
esac

# Resolve version
PHP_VERSION=1.0.0
if [ ! -z "${OPENSHIFT_PHP_VERSION}" ] && [ -d "${OPENSHIFT_PHP_DIR}/usr/cartridge-${OPENSHIFT_PHP_VERSION}/" ]; then
    PHP_VERSION="${OPENSHIFT_PHP_VERSION}"
elif [ -d "${OPENSHIFT_PHP_DIR}/usr/cartridge-${version}/" ]; then
    PHP_VERSION="${version}"
fi

PHP_VERSION_DIR=${OPENSHIFT_PHP_DIR}/usr/cartridge-${PHP_VERSION}

# Create dirs
mkdir -p ${OPENSHIFT_PHP_DIR}/{pid,socket,run,ext,composer/.composer,composer/bin,conf/ext}

# Set version env variables
echo "${PHP_VERSION}" > env/OPENSHIFT_PHP_VERSION
echo "${PHP_VERSION_DIR}" > env/OPENSHIFT_PHP_VERSION_DIR
echo "${PHP_VERSION_DIR}/bin:${OPENSHIFT_PHP_DIR}/composer/bin:${OPENSHIFT_PHP_DIR}/usr/bin" > env/OPENSHIFT_PHP_PATH_ELEMENT
echo "${PHP_VERSION_DIR}/ext" > env/OPENSHIFT_PHP_EXTENSION_DIR
# echo $(eval echo `${PHP_VERSION_DIR}/bin/php-config --extension-dir`) > env/OPENSHIFT_PHP_EXTENSION_DIR


# Resolve version
NGINX_VERSION=1.0.0
if [ ! -z "${OPENSHIFT_PHP_VERSION}" ] && [ -d "${OPENSHIFT_PHP_DIR}/usr/cartridge-${OPENSHIFT_PHP_VERSION}/" ]; then
    NGINX_VERSION="${OPENSHIFT_PHP_VERSION}"
elif [ -d "${OPENSHIFT_PHP_DIR}/usr/cartridge-${version}/" ]; then
    NGINX_VERSION="${version}"
fi

# Create dirs
dirs=( "logs" "run" )
for dir in ${dirs[@]}; do
    mkdir -p "${OPENSHIFT_PHP_DIR}/${dir}"
done

# Set version env variable
export OPENSHIFT_PHP_VERSION=${NGINX_VERSION}

echo "${NGINX_VERSION}" > ${OPENSHIFT_PHP_DIR}/env/OPENSHIFT_PHP_VERSION
echo "${OPENSHIFT_PHP_DIR}/usr/cartridge-${OPENSHIFT_PHP_VERSION}" > ${OPENSHIFT_PHP_DIR}/env/OPENSHIFT_PHP_VERSION_DIR

cp ${OPENSHIFT_PHP_DIR}/conf/php-fpm.ini.erb ${OPENSHIFT_REPO_DIR}/.openshift/php-fpm.ini.erb
cp ${OPENSHIFT_PHP_DIR}/conf/php-fpm.conf.erb ${OPENSHIFT_REPO_DIR}/.openshift/php-fpm.conf.erb
cp ${OPENSHIFT_PHP_EXTENSION_DIR}/extension.ini.erb ${OPENSHIFT_REPO_DIR}/.openshift/extension.ini.erb
cp ${OPENSHIFT_PHP_DIR}/conf/nginx_http.conf ${OPENSHIFT_REPO_DIR}/.openshift/nginx.conf.erb